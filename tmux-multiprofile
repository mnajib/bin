#!/usr/bin/env bash
# tmux-multiprofile.sh
# Najib & ChatGPT — functional, profile-based tmux layout manager
# Preserves pure/impure separation, Maybe-style checks, default profiles,
# session/window renaming, friendly ASCII messages, --verbose/--debug, --list.

set -euo pipefail

# ----------------------------
# Immutable defaults (do not mutate)
# ----------------------------
readonly VERSION="1.5.1"
readonly AUTHOR="Najib"
readonly APP_NAME="tmux-multiprofile"
readonly PROFILE_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/${APP_NAME}/profiles"

# ----------------------------
# Maybe helpers (pure)
# ----------------------------
maybe_just()  { printf "Just:%s" "$1"; }
maybe_nothing(){ printf "Nothing"; }
maybe_is_just(){ [[ "$1" == Just:* ]]; }
maybe_from_just(){ [[ "$1" == Just:* ]] && printf "%s" "${1#Just:}"; }

# ----------------------------
# Pure helpers (no side effects)
# ----------------------------
_pure_usage() {
  cat <<EOF
Usage:
  ${APP_NAME} [options] [profile-name]

Options:
  --help        Show this help message
  --version     Show version info
  --about       Show about info
  --debug       Enable debug trace output
  --verbose     Show concise progress output
  --list        List available profiles

Examples:
  ${APP_NAME} --help
  ${APP_NAME} logging
  ${APP_NAME} --verbose logging

Profiles directory:
  ${PROFILE_DIR}
EOF
}

_pure_version() {
  printf "%s version %s\n" "${APP_NAME}" "${VERSION}"
}

_pure_about() {
  cat <<EOF
${APP_NAME} — Functional-style tmux layout manager
Author : ${AUTHOR}
Version: ${VERSION}
License: MIT

Design:
  - Separation: pure functions (_pure_*) vs impure (_impure_*)
  - Maybe-style checks to avoid surprising failures
  - Profiles stored as plain text .profile files (tmux source-file compatible)
  - Default profiles auto-created (idempotent)
EOF
}

# Return newline-separated profile names (pure)
_pure_list_profiles() {
  if [[ -d "${PROFILE_DIR}" ]]; then
    find "${PROFILE_DIR}" -maxdepth 1 -type f -name "*.profile" -printf "%f\n" | sed 's/\.profile$//'
  fi
}

# Ensure default profiles exist (idempotent) (pure-ish — writes files)
_pure_ensure_profiles() {
  mkdir -p "${PROFILE_DIR}"

  local created=()

  if [[ ! -f "${PROFILE_DIR}/logging.profile" ]]; then
    cat > "${PROFILE_DIR}/logging.profile" <<'PROFILE'
# Logging profile: monitoring + network windows
rename-session LoggingSession
rename-window SysMonitor
split-window -v -p 60 -t 'SysMonitor' 'htop'
split-window -h -t 'SysMonitor' 'iotop'
select-pane -t 'SysMonitor'.0
new-window -n NetMonitor
split-window -v -t NetMonitor 'iftop'
split-window -h -t NetMonitor 'watch -n1 ss -tuna'
select-window -t NetMonitor
PROFILE
    created+=("logging")
  fi

  if [[ ! -f "${PROFILE_DIR}/config.profile" ]]; then
    cat > "${PROFILE_DIR}/config.profile" <<'PROFILE'
# Config profile: system + user config windows
rename-session ConfigSession
rename-window SystemConfig
split-window -h -t SystemConfig
send-keys -t SystemConfig.0 'cd /etc && nvim' C-m
send-keys -t SystemConfig.1 'cd /var/log && less' C-m

new-window -n UserConfig
split-window -h -t UserConfig
send-keys -t UserConfig.0 'cd ~/dotfiles && nvim' C-m
send-keys -t UserConfig.1 'cd ~ && ls -la' C-m
select-window -t SystemConfig
PROFILE
    created+=("config")
  fi

  if [[ ! -f "${PROFILE_DIR}/development.profile" ]]; then
    cat > "${PROFILE_DIR}/development.profile" <<'PROFILE'
# Development profile: editor, repl, logs
rename-session DevSession
rename-window Editor
split-window -v -t Editor
send-keys -t Editor.0 'cd ~/projects && nvim' C-m
send-keys -t Editor.1 'ghci' C-m

new-window -n Logs
split-window -v -t Logs
send-keys -t Logs.0 'tail -f /var/log/syslog' C-m
send-keys -t Logs.1 'journalctl -f' C-m

new-window -n Shells
split-window -h -t Shells
send-keys -t Shells.0 'cd ~/projects; bash' C-m
send-keys -t Shells.1 'cd ~/src; bash' C-m
select-window -t Editor
PROFILE
    created+=("development")
  fi

  if (( ${#created[@]} > 0 )); then
    printf "Created default profiles: %s\n" "${created[*]}"
  fi
}

# Validate inside tmux (returns Maybe)
_pure_check_in_tmux() {
  [[ -n "${TMUX:-}" ]] && maybe_just "in-tmux" || maybe_nothing
}

# ----------------------------
# Impure functions (side effects)
# ----------------------------
# Minimal, well-formatted messages

# debug trace (impure): prints when debug=true
_impure_dbg() {
  local debug="$1"; shift
  if [[ "${debug}" == "true" ]]; then
    printf "[DEBUG] %s\n" "$*"
  fi
}

# concise verbose info (impure): prints when verbose=true
_impure_verbose() {
  local verbose="$1"; shift
  if [[ "${verbose}" == "true" ]]; then
    printf "  %s\n" "$*"
  fi
}

# Pretty error and exit
_impure_error() {
  local msg="$1"
  echo
  echo "  [ERROR]"
  echo "    ${msg}"
  echo
  printf "  Available profiles:\n"
  _pure_list_profiles | sed 's/^/    - /'
  echo
  exit 1
}

# Apply profile file (impure)
_impure_apply_profile() {
  local profile_file="$1"
  local debug="$2"
  local verbose="$3"

  [[ -f "${profile_file}" ]] || _impure_error "Profile not found: ${profile_file}"

  _impure_dbg "${debug}" "sourcing ${profile_file}"
  if [[ "${verbose}" == "true" ]]; then
    printf "\n  Applying profile: %s\n" "$(basename "${profile_file}" .profile)"
  fi

  # Source the profile to run tmux commands (profile contains tmux commands)
  # use tmux source-file: it executes commands inside tmux server context
  tmux source-file "${profile_file}"

  _impure_verbose "${verbose}" "Profile applied."
}

# List profiles cleanly (impure)
_impure_list_profiles() {
  local p
  _impure_verbose "$1" "Available profiles:"
  while IFS= read -r p; do
    printf "    - %s\n" "$p"
  done < <(_pure_list_profiles)
}

# ----------------------------
# Argument parsing and main
# ----------------------------
_main() {
  # runtime flags (locals; keep globals immutable)
  local debug="false"
  local verbose="false"
  local list_only="false"
  local arg=""

  # parse arguments (all; keep flags until profile resolves)
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --help) _pure_usage; exit 0 ;;
      --version) _pure_version; exit 0 ;;
      --about) _pure_about; exit 0 ;;
      --debug) debug="true"; shift; continue ;;
      --verbose) verbose="true"; shift; continue ;;
      --list) list_only="true"; shift; continue ;;
      --) shift; break ;;
      --*) _impure_error "Unknown option: $1" ;;
      *) arg="$1"; shift; break ;;
    esac
  done

  # Ensure default profiles exist (idempotent)
  _pure_ensure_profiles

  # If user asked --list (or ran --verbose without profile earlier), show profiles and exit
  if [[ "${list_only}" == "true" ]]; then
    _impure_list_profiles "${verbose}"
    exit 0
  fi

  # If no profile provided
  if [[ -z "${arg}" ]]; then
    # If debug requested, print diagnostic info
    if [[ "${debug}" == "true" ]]; then
      echo
      echo "  ${APP_NAME} - debug info"
      echo "    Version   : ${VERSION}"
      echo "    Author    : ${AUTHOR}"
      echo "    Profiles  : ${PROFILE_DIR}"
      echo "    TMUX env  : ${TMUX:-<not set>}"
      echo
      _impure_list_profiles "${verbose}"
      exit 0
    fi

    # Default: print usage (keeps behavior non-noisy)
    _pure_usage
    exit 0
  fi

  # check tmux context (we require running inside tmux to apply)
  if ! maybe_is_just "$(_pure_check_in_tmux)"; then
    _impure_error "Not inside a tmux session. Start tmux (e.g. 'tmux new -s NAME') and rerun."
  fi

  # profile path
  local profile_file="${PROFILE_DIR}/${arg}.profile"
  if [[ ! -f "${profile_file}" ]]; then
    _impure_error "Unknown profile: ${arg}"
  fi

  # final apply
  _impure_apply_profile "${profile_file}" "${debug}" "${verbose}"
}

# Entrypoint
_main "$@"

